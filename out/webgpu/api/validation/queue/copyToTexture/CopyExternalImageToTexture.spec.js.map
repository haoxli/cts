{"version":3,"sources":["../../../../../../src/webgpu/api/validation/queue/copyToTexture/CopyExternalImageToTexture.spec.ts"],"names":["description","getResourcePath","makeTestGroup","raceWithRejectOnTimeout","unreachable","assert","kTextureFormatInfo","kTextureFormats","kTextureUsages","kValidTextureFormatsForCopyE2T","kResourceStates","canCopyFromCanvasContext","createCanvas","createOnscreenCanvas","createOffscreenCanvas","kValidCanvasContextIds","ValidationTest","kDefaultBytesPerPixel","kDefaultWidth","kDefaultHeight","kDefaultDepth","kDefaultMipLevelCount","computeMipMapSize","width","height","mipLevel","mipWidth","Math","max","mipHeight","generateCopySizeForSrcOOB","srcOrigin","x","y","depthOrArrayLayers","justFitCopySize","generateDstOriginValue","origin","z","generateCopySizeForDstOOB","dstOrigin","dstMipMapSize","CopyExternalImageToTextureTest","getImageData","pixelSize","imagePixels","Uint8ClampedArray","ImageData","getCanvasWithContent","canvasType","content","canvas","ctx","getContext","drawImage","runTest","imageBitmapCopyView","textureCopyView","copySize","validationScopeSuccess","exceptionName","shouldThrow","device","queue","copyExternalImageToTexture","expectValidationError","g","test","desc","params","u","combine","beginSubcases","fn","t","contextType","dstTexture","createTexture","size","format","usage","GPUTextureUsage","COPY_DST","RENDER_ATTACHMENT","skip","tryTrackForCleanup","source","texture","sourceImage","isOriginClean","contentFrom","crossOriginUrl","originCleanUrl","img","document","createElement","src","timeout_ms","decode","e","warn","createImageBitmap","externalImage","closed","imageBitmap","close","state","transferControlToOffscreen","offscreenCanvas","messageChannel","MessageChannel","port1","postMessage","port2FirstMessage","Promise","resolve","port2","onmessage","m","receivedOffscreenCanvas","data","createTextureWithState","paramsSubcasesOnly","mismatched","selectMismatchedDeviceOrSkipTestCase","undefined","mismatchedDevice","dimension","sampleCount","mipLevelCount","selectDeviceOrSkipTestCase","feature","pushErrorScope","popErrorScope","success","includes","expand","hasOperationError"],"mappings":"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","sourcesContent":["export const description = `\ncopyExternalImageToTexture Validation Tests in Queue.\n`;\n\nimport { getResourcePath } from '../../../../../common/framework/resources.js';\nimport { makeTestGroup } from '../../../../../common/framework/test_group.js';\nimport { raceWithRejectOnTimeout, unreachable, assert } from '../../../../../common/util/util.js';\nimport {\n  kTextureFormatInfo,\n  kTextureFormats,\n  kTextureUsages,\n  kValidTextureFormatsForCopyE2T,\n} from '../../../../capability_info.js';\nimport { kResourceStates } from '../../../../gpu_test.js';\nimport {\n  CanvasType,\n  canCopyFromCanvasContext,\n  createCanvas,\n  createOnscreenCanvas,\n  createOffscreenCanvas,\n  kValidCanvasContextIds,\n} from '../../../../util/create_elements.js';\nimport { ValidationTest } from '../../validation_test.js';\n\nconst kDefaultBytesPerPixel = 4; // using 'bgra8unorm' or 'rgba8unorm'\nconst kDefaultWidth = 32;\nconst kDefaultHeight = 32;\nconst kDefaultDepth = 1;\nconst kDefaultMipLevelCount = 6;\n\nfunction computeMipMapSize(width: number, height: number, mipLevel: number) {\n  return {\n    mipWidth: Math.max(width >> mipLevel, 1),\n    mipHeight: Math.max(height >> mipLevel, 1),\n  };\n}\n\ninterface WithMipLevel {\n  mipLevel: number;\n}\n\ninterface WithDstOriginMipLevel extends WithMipLevel {\n  dstOrigin: Required<GPUOrigin3DDict>;\n}\n\n// Helper function to generate copySize for src OOB test\nfunction generateCopySizeForSrcOOB({ srcOrigin }: { srcOrigin: Required<GPUOrigin2DDict> }) {\n  // OOB origin fails even with no-op copy.\n  if (srcOrigin.x > kDefaultWidth || srcOrigin.y > kDefaultHeight) {\n    return [{ width: 0, height: 0, depthOrArrayLayers: 0 }];\n  }\n\n  const justFitCopySize = {\n    width: kDefaultWidth - srcOrigin.x,\n    height: kDefaultHeight - srcOrigin.y,\n    depthOrArrayLayers: 1,\n  };\n\n  return [\n    justFitCopySize, // correct size, maybe no-op copy.\n    { width: justFitCopySize.width + 1, height: justFitCopySize.height, depthOrArrayLayers: 1 }, // OOB in width\n    { width: justFitCopySize.width, height: justFitCopySize.height + 1, depthOrArrayLayers: 1 }, // OOB in height\n    { width: justFitCopySize.width, height: justFitCopySize.height, depthOrArrayLayers: 2 }, // OOB in depthOrArrayLayers\n  ];\n}\n\n// Helper function to generate dst origin value based on mipLevel.\nfunction generateDstOriginValue({ mipLevel }: WithMipLevel) {\n  const origin = computeMipMapSize(kDefaultWidth, kDefaultHeight, mipLevel);\n\n  return [\n    { x: 0, y: 0, z: 0 },\n    { x: origin.mipWidth - 1, y: 0, z: 0 },\n    { x: 0, y: origin.mipHeight - 1, z: 0 },\n    { x: origin.mipWidth, y: 0, z: 0 },\n    { x: 0, y: origin.mipHeight, z: 0 },\n    { x: 0, y: 0, z: kDefaultDepth },\n    { x: origin.mipWidth + 1, y: 0, z: 0 },\n    { x: 0, y: origin.mipHeight + 1, z: 0 },\n    { x: 0, y: 0, z: kDefaultDepth + 1 },\n  ];\n}\n\n// Helper function to generate copySize for dst OOB test\nfunction generateCopySizeForDstOOB({ mipLevel, dstOrigin }: WithDstOriginMipLevel) {\n  const dstMipMapSize = computeMipMapSize(kDefaultWidth, kDefaultHeight, mipLevel);\n\n  // OOB origin fails even with no-op copy.\n  if (\n    dstOrigin.x > dstMipMapSize.mipWidth ||\n    dstOrigin.y > dstMipMapSize.mipHeight ||\n    dstOrigin.z > kDefaultDepth\n  ) {\n    return [{ width: 0, height: 0, depthOrArrayLayers: 0 }];\n  }\n\n  const justFitCopySize = {\n    width: dstMipMapSize.mipWidth - dstOrigin.x,\n    height: dstMipMapSize.mipHeight - dstOrigin.y,\n    depthOrArrayLayers: kDefaultDepth - dstOrigin.z,\n  };\n\n  return [\n    justFitCopySize,\n    {\n      width: justFitCopySize.width + 1,\n      height: justFitCopySize.height,\n      depthOrArrayLayers: justFitCopySize.depthOrArrayLayers,\n    }, // OOB in width\n    {\n      width: justFitCopySize.width,\n      height: justFitCopySize.height + 1,\n      depthOrArrayLayers: justFitCopySize.depthOrArrayLayers,\n    }, // OOB in height\n    {\n      width: justFitCopySize.width,\n      height: justFitCopySize.height,\n      depthOrArrayLayers: justFitCopySize.depthOrArrayLayers + 1,\n    }, // OOB in depthOrArrayLayers\n  ];\n}\n\nclass CopyExternalImageToTextureTest extends ValidationTest {\n  getImageData(width: number, height: number): ImageData {\n    const pixelSize = kDefaultBytesPerPixel * width * height;\n    const imagePixels = new Uint8ClampedArray(pixelSize);\n    return new ImageData(imagePixels, width, height);\n  }\n\n  getCanvasWithContent(\n    canvasType: CanvasType,\n    width: number,\n    height: number,\n    content: HTMLImageElement | HTMLCanvasElement | OffscreenCanvas | ImageBitmap\n  ): HTMLCanvasElement | OffscreenCanvas {\n    const canvas = createCanvas(this, canvasType, 1, 1);\n    const ctx = canvas.getContext('2d');\n    assert(ctx !== null);\n    ctx.drawImage(content, 0, 0);\n\n    return canvas;\n  }\n\n  runTest(\n    imageBitmapCopyView: GPUImageCopyExternalImage,\n    textureCopyView: GPUImageCopyTextureTagged,\n    copySize: GPUExtent3D,\n    validationScopeSuccess: boolean,\n    exceptionName?: string\n  ): void {\n    // copyExternalImageToTexture will generate two types of errors. One is synchronous exceptions;\n    // the other is asynchronous validation error scope errors.\n    if (exceptionName) {\n      this.shouldThrow(exceptionName, () => {\n        this.device.queue.copyExternalImageToTexture(\n          imageBitmapCopyView,\n          textureCopyView,\n          copySize\n        );\n      });\n    } else {\n      this.expectValidationError(() => {\n        this.device.queue.copyExternalImageToTexture(\n          imageBitmapCopyView,\n          textureCopyView,\n          copySize\n        );\n      }, !validationScopeSuccess);\n    }\n  }\n}\n\nexport const g = makeTestGroup(CopyExternalImageToTextureTest);\n\ng.test('source_canvas,contexts')\n  .desc(\n    `\n  Test HTMLCanvasElement as source image with different contexts.\n\n  Call HTMLCanvasElement.getContext() with different context type.\n  Only '2d', 'experimental-webgl', 'webgl', 'webgl2' is valid context\n  type.\n\n  Check whether 'OperationError' is generated when context type is invalid.\n  `\n  )\n  .params(u =>\n    u //\n      .combine('contextType', kValidCanvasContextIds)\n      .beginSubcases()\n      .combine('copySize', [\n        { width: 0, height: 0, depthOrArrayLayers: 0 },\n        { width: 1, height: 1, depthOrArrayLayers: 1 },\n      ])\n  )\n  .fn(async t => {\n    const { contextType, copySize } = t.params;\n    const canvas = createOnscreenCanvas(t, 1, 1);\n    const dstTexture = t.device.createTexture({\n      size: { width: 1, height: 1, depthOrArrayLayers: 1 },\n      format: 'bgra8unorm',\n      usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    const ctx = canvas.getContext(contextType);\n    if (ctx === null) {\n      t.skip('Failed to get context for canvas element');\n      return;\n    }\n    t.tryTrackForCleanup(ctx);\n\n    t.runTest(\n      { source: canvas },\n      { texture: dstTexture },\n      copySize,\n      true, // No validation errors.\n      canCopyFromCanvasContext(contextType) ? '' : 'OperationError'\n    );\n  });\n\ng.test('source_offscreenCanvas,contexts')\n  .desc(\n    `\n  Test OffscreenCanvas as source image with different contexts.\n\n  Call OffscreenCanvas.getContext() with different context type.\n  Only '2d', 'webgl', 'webgl2', 'webgpu' is valid context type.\n\n  Check whether 'OperationError' is generated when context type is invalid.\n  `\n  )\n  .params(u =>\n    u //\n      .combine('contextType', kValidCanvasContextIds)\n      .beginSubcases()\n      .combine('copySize', [\n        { width: 0, height: 0, depthOrArrayLayers: 0 },\n        { width: 1, height: 1, depthOrArrayLayers: 1 },\n      ])\n  )\n  .fn(async t => {\n    const { contextType, copySize } = t.params;\n    const canvas = createOffscreenCanvas(t, 1, 1);\n    const dstTexture = t.device.createTexture({\n      size: { width: 1, height: 1, depthOrArrayLayers: 1 },\n      format: 'bgra8unorm',\n      usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    // MAINTENANCE_TODO: Workaround for @types/offscreencanvas missing an overload of\n    // `OffscreenCanvas.getContext` that takes `string` or a union of context types.\n    const ctx = ((canvas as unknown) as HTMLCanvasElement).getContext(contextType);\n\n    if (ctx === null) {\n      t.skip('Failed to get context for canvas element');\n      return;\n    }\n    t.tryTrackForCleanup(ctx);\n\n    t.runTest(\n      { source: canvas },\n      { texture: dstTexture },\n      copySize,\n      true, // No validation errors.\n      canCopyFromCanvasContext(contextType) ? '' : 'OperationError'\n    );\n  });\n\ng.test('source_image,crossOrigin')\n  .desc(\n    `\n  Test contents of source image is [clean, cross-origin].\n\n  Load crossOrigin image or same origin image and init the source\n  images.\n\n  Check whether 'SecurityError' is generated when source image is not origin clean.\n\n  TODO: make this test case work offline, ref link to achieve this :\n  https://web-platform-tests.org/writing-tests/server-features.html#tests-involving-multiple-origins\n  `\n  )\n  .params(u =>\n    u //\n      .combine('sourceImage', ['canvas', 'offscreenCanvas', 'imageBitmap'])\n      .combine('isOriginClean', [true, false])\n      .beginSubcases()\n      .combine('contentFrom', ['image', 'imageBitmap', 'canvas', 'offscreenCanvas'] as const)\n      .combine('copySize', [\n        { width: 0, height: 0, depthOrArrayLayers: 0 },\n        { width: 1, height: 1, depthOrArrayLayers: 1 },\n      ])\n  )\n  .fn(async t => {\n    const { sourceImage, isOriginClean, contentFrom, copySize } = t.params;\n\n    const crossOriginUrl = 'https://get.webgl.org/conformance-resources/opengl_logo.jpg';\n    const originCleanUrl = getResourcePath('Di-3d.png');\n\n    const img = document.createElement('img');\n    img.src = isOriginClean ? originCleanUrl : crossOriginUrl;\n\n    // Load image\n    const timeout_ms = 5000;\n    try {\n      await raceWithRejectOnTimeout(img.decode(), timeout_ms, 'load image timeout');\n    } catch (e) {\n      if (isOriginClean) {\n        throw e;\n      } else {\n        t.warn('Something wrong happens in get.webgl.org');\n        t.skip('Cannot load image in time');\n        return;\n      }\n    }\n\n    // The externalImage contents can be updated by:\n    // - decoded image element\n    // - canvas/offscreenCanvas with image draw on it.\n    // - imageBitmap created with the image.\n    // Test covers all of these cases to ensure origin clean checks works.\n    let source: HTMLImageElement | HTMLCanvasElement | OffscreenCanvas | ImageBitmap;\n    switch (contentFrom) {\n      case 'image': {\n        source = img;\n        break;\n      }\n      case 'imageBitmap': {\n        source = await createImageBitmap(img);\n        break;\n      }\n      case 'canvas':\n      case 'offscreenCanvas': {\n        const canvasType = contentFrom === 'offscreenCanvas' ? 'offscreen' : 'onscreen';\n        source = t.getCanvasWithContent(canvasType, 1, 1, img);\n        break;\n      }\n      default:\n        unreachable();\n    }\n\n    // Update the externalImage content with source.\n    let externalImage: HTMLCanvasElement | OffscreenCanvas | ImageBitmap;\n    switch (sourceImage) {\n      case 'imageBitmap': {\n        externalImage = await createImageBitmap(source);\n        break;\n      }\n      case 'canvas':\n      case 'offscreenCanvas': {\n        const canvasType = contentFrom === 'offscreenCanvas' ? 'offscreen' : 'onscreen';\n        externalImage = t.getCanvasWithContent(canvasType, 1, 1, source);\n        break;\n      }\n      default:\n        unreachable();\n    }\n\n    const dstTexture = t.device.createTexture({\n      size: { width: 1, height: 1, depthOrArrayLayers: 1 },\n      format: 'bgra8unorm',\n      usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    t.runTest(\n      { source: externalImage },\n      { texture: dstTexture },\n      copySize,\n      true, // No validation errors.\n      isOriginClean ? '' : 'SecurityError'\n    );\n  });\n\ng.test('source_imageBitmap,state')\n  .desc(\n    `\n  Test ImageBitmap as source image in state [valid, closed].\n\n  Call imageBitmap.close() to transfer the imageBitmap into\n  'closed' state.\n\n  Check whether 'InvalidStateError' is generated when ImageBitmap is\n  closed.\n  `\n  )\n  .params(u =>\n    u //\n      .combine('closed', [false, true])\n      .beginSubcases()\n      .combine('copySize', [\n        { width: 0, height: 0, depthOrArrayLayers: 0 },\n        { width: 1, height: 1, depthOrArrayLayers: 1 },\n      ])\n  )\n  .fn(async t => {\n    const { closed, copySize } = t.params;\n    const imageBitmap = await createImageBitmap(t.getImageData(1, 1));\n    const dstTexture = t.device.createTexture({\n      size: { width: 1, height: 1, depthOrArrayLayers: 1 },\n      format: 'bgra8unorm',\n      usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    if (closed) imageBitmap.close();\n\n    t.runTest(\n      { source: imageBitmap },\n      { texture: dstTexture },\n      copySize,\n      true, // No validation errors.\n      closed ? 'InvalidStateError' : ''\n    );\n  });\n\ng.test('source_canvas,state')\n  .desc(\n    `\n  Test HTMLCanvasElement as source image in state\n  [nocontext, 'placeholder-nocontext', 'placeholder-hascontext', valid].\n\n  Nocontext means using a canvas without any context as copy param.\n\n  Call 'transferControlToOffscreen' on HTMLCanvasElement will cause the\n  canvas control right transfer. And this canvas is in state 'placeholder'\n  Whether getContext in new generated offscreenCanvas won't affect the origin\n  canvas state.\n\n\n  Check whether 'OperationError' is generated when HTMLCanvasElement has no\n  context.\n\n  Check whether 'InvalidStateError' is generated when HTMLCanvasElement is\n  in 'placeholder' state.\n    `\n  )\n  .params(u =>\n    u //\n      .combine('state', ['nocontext', 'placeholder-nocontext', 'placeholder-hascontext', 'valid'])\n      .beginSubcases()\n      .combine('copySize', [\n        { width: 0, height: 0, depthOrArrayLayers: 0 },\n        { width: 1, height: 1, depthOrArrayLayers: 1 },\n      ])\n  )\n  .fn(async t => {\n    const { state, copySize } = t.params;\n    const canvas = createOnscreenCanvas(t, 1, 1);\n    if (typeof canvas.transferControlToOffscreen === 'undefined') {\n      t.skip(\"Browser doesn't support HTMLCanvasElement transfer control right\");\n      return;\n    }\n\n    const dstTexture = t.device.createTexture({\n      size: { width: 1, height: 1, depthOrArrayLayers: 1 },\n      format: 'bgra8unorm',\n      usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    let exceptionName: string = '';\n\n    switch (state) {\n      case 'nocontext': {\n        exceptionName = 'OperationError';\n        break;\n      }\n      case 'placeholder-nocontext': {\n        canvas.transferControlToOffscreen();\n        exceptionName = 'InvalidStateError';\n        break;\n      }\n      case 'placeholder-hascontext': {\n        const offscreenCanvas = canvas.transferControlToOffscreen();\n        t.tryTrackForCleanup(offscreenCanvas.getContext('webgl'));\n        exceptionName = 'InvalidStateError';\n        break;\n      }\n      case 'valid': {\n        assert(canvas.getContext('2d') !== null);\n        break;\n      }\n      default:\n        unreachable();\n    }\n\n    t.runTest(\n      { source: canvas },\n      { texture: dstTexture },\n      copySize,\n      true, // No validation errors.\n      exceptionName\n    );\n  });\n\ng.test('source_offscreenCanvas,state')\n  .desc(\n    `\n  Test OffscreenCanvas as source image in state [valid, detached].\n\n  Nocontext means using a canvas without any context as copy param.\n\n  Transfer OffscreenCanvas with MessageChannel will detach the OffscreenCanvas.\n\n  Check whether 'OperationError' is generated when HTMLCanvasElement has no\n  context.\n\n  Check whether 'InvalidStateError' is generated when OffscreenCanvas is\n  detached.\n  `\n  )\n  .params(u =>\n    u //\n      .combine('state', ['nocontext', 'detached-nocontext', 'detached-hascontext', 'valid'])\n      .beginSubcases()\n      .combine('getContextInOffscreenCanvas', [false, true])\n      .combine('copySize', [\n        { width: 0, height: 0, depthOrArrayLayers: 0 },\n        { width: 1, height: 1, depthOrArrayLayers: 1 },\n      ])\n  )\n  .fn(async t => {\n    const { state, copySize } = t.params;\n    const offscreenCanvas = createOffscreenCanvas(t, 1, 1);\n    const dstTexture = t.device.createTexture({\n      size: { width: 1, height: 1, depthOrArrayLayers: 1 },\n      format: 'bgra8unorm',\n      usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    let exceptionName: string = '';\n    switch (state) {\n      case 'nocontext': {\n        exceptionName = 'OperationError';\n        break;\n      }\n      case 'detached-nocontext': {\n        const messageChannel = new MessageChannel();\n        messageChannel.port1.postMessage(offscreenCanvas, [offscreenCanvas]);\n\n        exceptionName = 'InvalidStateError';\n        break;\n      }\n      case 'detached-hascontext': {\n        const messageChannel = new MessageChannel();\n        const port2FirstMessage = new Promise(resolve => {\n          messageChannel.port2.onmessage = m => resolve(m);\n        });\n\n        messageChannel.port1.postMessage(offscreenCanvas, [offscreenCanvas]);\n\n        const receivedOffscreenCanvas = (await port2FirstMessage) as MessageEvent;\n        t.tryTrackForCleanup(receivedOffscreenCanvas.data.getContext('webgl'));\n\n        exceptionName = 'InvalidStateError';\n        break;\n      }\n      case 'valid': {\n        offscreenCanvas.getContext('webgl');\n        break;\n      }\n      default:\n        unreachable();\n    }\n\n    t.runTest(\n      { source: offscreenCanvas },\n      { texture: dstTexture },\n      copySize,\n      true, // No validation errors.\n      exceptionName\n    );\n  });\n\ng.test('destination_texture,state')\n  .desc(\n    `\n  Test dst texture is [valid, invalid, destroyed].\n\n  Check that an error is generated when texture is an error texture.\n  Check that an error is generated when texture is in destroyed state.\n  `\n  )\n  .params(u =>\n    u //\n      .combine('state', kResourceStates)\n      .beginSubcases()\n      .combine('copySize', [\n        { width: 0, height: 0, depthOrArrayLayers: 0 },\n        { width: 1, height: 1, depthOrArrayLayers: 1 },\n      ])\n  )\n  .fn(async t => {\n    const { state, copySize } = t.params;\n    const imageBitmap = await createImageBitmap(t.getImageData(1, 1));\n    const dstTexture = t.createTextureWithState(state);\n\n    t.runTest({ source: imageBitmap }, { texture: dstTexture }, copySize, state === 'valid');\n  });\n\ng.test('destination_texture,device_mismatch')\n  .desc(\n    'Tests copyExternalImageToTexture cannot be called with a destination texture created from another device'\n  )\n  .paramsSubcasesOnly(u => u.combine('mismatched', [true, false]))\n  .fn(async t => {\n    const { mismatched } = t.params;\n\n    if (mismatched) {\n      await t.selectMismatchedDeviceOrSkipTestCase(undefined);\n    }\n\n    const device = mismatched ? t.mismatchedDevice : t.device;\n    const copySize = { width: 1, height: 1, depthOrArrayLayers: 1 };\n\n    const texture = device.createTexture({\n      size: copySize,\n      format: 'rgba8unorm',\n      usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    const imageBitmap = await createImageBitmap(t.getImageData(1, 1));\n\n    t.runTest({ source: imageBitmap }, { texture }, copySize, !mismatched);\n  });\n\ng.test('destination_texture,dimension')\n  .desc(\n    `\n  Test dst texture dimension is [1d, 2d, 3d].\n\n  Check that an error is generated when texture is not '2d' dimension.\n  `\n  )\n  .params(u =>\n    u //\n      .combine('dimension', ['1d', '2d', '3d'] as const)\n      .beginSubcases()\n      .combine('copySize', [\n        { width: 0, height: 0, depthOrArrayLayers: 0 },\n        { width: 1, height: 1, depthOrArrayLayers: 1 },\n      ])\n  )\n  .fn(async t => {\n    const { dimension, copySize } = t.params;\n    const imageBitmap = await createImageBitmap(t.getImageData(1, 1));\n    const dstTexture = t.device.createTexture({\n      size: { width: 1, height: 1, depthOrArrayLayers: 1 },\n      format: 'rgba8unorm',\n      usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n      dimension,\n    });\n\n    t.runTest({ source: imageBitmap }, { texture: dstTexture }, copySize, dimension === '2d');\n  });\n\ng.test('destination_texture,usage')\n  .desc(\n    `\n  Test dst texture usages\n\n  Check that an error is generated when texture is created without usage COPY_DST | RENDER_ATTACHMENT.\n  `\n  )\n  .params(u =>\n    u //\n      .combine('usage', kTextureUsages)\n      .beginSubcases()\n      .combine('copySize', [\n        { width: 0, height: 0, depthOrArrayLayers: 0 },\n        { width: 1, height: 1, depthOrArrayLayers: 1 },\n      ])\n  )\n  .fn(async t => {\n    const { usage, copySize } = t.params;\n    const imageBitmap = await createImageBitmap(t.getImageData(1, 1));\n    const dstTexture = t.device.createTexture({\n      size: { width: 1, height: 1, depthOrArrayLayers: 1 },\n      format: 'rgba8unorm',\n      usage,\n    });\n\n    t.runTest(\n      { source: imageBitmap },\n      { texture: dstTexture },\n      copySize,\n      !!(usage & GPUTextureUsage.COPY_DST && usage & GPUTextureUsage.RENDER_ATTACHMENT)\n    );\n  });\n\ng.test('destination_texture,sample_count')\n  .desc(\n    `\n  Test dst texture sample count.\n\n  Check that an error is generated when sample count it not 1.\n  `\n  )\n  .params(u =>\n    u //\n      .combine('sampleCount', [1, 4])\n      .beginSubcases()\n      .combine('copySize', [\n        { width: 0, height: 0, depthOrArrayLayers: 0 },\n        { width: 1, height: 1, depthOrArrayLayers: 1 },\n      ])\n  )\n  .fn(async t => {\n    const { sampleCount, copySize } = t.params;\n    const imageBitmap = await createImageBitmap(t.getImageData(1, 1));\n    const dstTexture = t.device.createTexture({\n      size: { width: 1, height: 1, depthOrArrayLayers: 1 },\n      sampleCount,\n      format: 'bgra8unorm',\n      usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    t.runTest({ source: imageBitmap }, { texture: dstTexture }, copySize, sampleCount === 1);\n  });\n\ng.test('destination_texture,mipLevel')\n  .desc(\n    `\n  Test dst mipLevel.\n\n  Check that an error is generated when mipLevel is too large.\n  `\n  )\n  .params(u =>\n    u //\n      .combine('mipLevel', [0, kDefaultMipLevelCount - 1, kDefaultMipLevelCount])\n      .beginSubcases()\n      .combine('copySize', [\n        { width: 0, height: 0, depthOrArrayLayers: 0 },\n        { width: 1, height: 1, depthOrArrayLayers: 1 },\n      ])\n  )\n  .fn(async t => {\n    const { mipLevel, copySize } = t.params;\n    const imageBitmap = await createImageBitmap(t.getImageData(1, 1));\n    const dstTexture = t.device.createTexture({\n      size: { width: kDefaultWidth, height: kDefaultHeight, depthOrArrayLayers: kDefaultDepth },\n      mipLevelCount: kDefaultMipLevelCount,\n      format: 'bgra8unorm',\n      usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    t.runTest(\n      { source: imageBitmap },\n      { texture: dstTexture, mipLevel },\n      copySize,\n      mipLevel < kDefaultMipLevelCount\n    );\n  });\n\ng.test('destination_texture,format')\n  .desc(\n    `\n  Test dst texture format.\n\n  Check that an error is generated when texture format is not valid.\n  `\n  )\n  .params(u =>\n    u\n      .combine('format', kTextureFormats)\n      .beginSubcases()\n      .combine('copySize', [\n        { width: 0, height: 0, depthOrArrayLayers: 0 },\n        { width: 1, height: 1, depthOrArrayLayers: 1 },\n      ])\n  )\n  .fn(async t => {\n    const { format, copySize } = t.params;\n    await t.selectDeviceOrSkipTestCase(kTextureFormatInfo[format].feature);\n\n    const imageBitmap = await createImageBitmap(t.getImageData(1, 1));\n\n    // createTexture with all possible texture format may have validation error when using\n    // compressed texture format.\n    t.device.pushErrorScope('validation');\n    const dstTexture = t.device.createTexture({\n      size: { width: 1, height: 1, depthOrArrayLayers: 1 },\n      format,\n      usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n    t.device.popErrorScope();\n\n    const success = (kValidTextureFormatsForCopyE2T as readonly string[]).includes(format);\n\n    t.runTest({ source: imageBitmap }, { texture: dstTexture }, copySize, success);\n  });\n\ng.test('OOB,source')\n  .desc(\n    `\n  Test source image origin and copy size\n\n  Check that an error is generated when source.externalImage.origin + copySize is too large.\n  `\n  )\n  .paramsSubcasesOnly(u =>\n    u\n      .combine('srcOrigin', [\n        { x: 0, y: 0 }, // origin is on top-left\n        { x: kDefaultWidth - 1, y: 0 }, // x near the border\n        { x: 0, y: kDefaultHeight - 1 }, // y is near the border\n        { x: kDefaultWidth, y: kDefaultHeight }, // origin is on bottom-right\n        { x: kDefaultWidth + 1, y: 0 }, // x is too large\n        { x: 0, y: kDefaultHeight + 1 }, // y is too large\n      ])\n      .expand('copySize', generateCopySizeForSrcOOB)\n  )\n  .fn(async t => {\n    const { srcOrigin, copySize } = t.params;\n    const imageBitmap = await createImageBitmap(t.getImageData(kDefaultWidth, kDefaultHeight));\n    const dstTexture = t.device.createTexture({\n      size: {\n        width: kDefaultWidth + 1,\n        height: kDefaultHeight + 1,\n        depthOrArrayLayers: kDefaultDepth,\n      },\n      mipLevelCount: kDefaultMipLevelCount,\n      format: 'bgra8unorm',\n      usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    let success = true;\n\n    if (\n      srcOrigin.x + copySize.width > kDefaultWidth ||\n      srcOrigin.y + copySize.height > kDefaultHeight ||\n      copySize.depthOrArrayLayers > 1\n    ) {\n      success = false;\n    }\n\n    t.runTest(\n      { source: imageBitmap, origin: srcOrigin },\n      { texture: dstTexture },\n      copySize,\n      true,\n      success ? '' : 'OperationError'\n    );\n  });\n\ng.test('OOB,destination')\n  .desc(\n    `\n  Test dst texture copy origin and copy size\n\n  Check that an error is generated when destination.texture.origin + copySize is too large.\n  Check that 'OperationError' is generated when copySize.depth is larger than 1.\n  `\n  )\n  .paramsSubcasesOnly(u =>\n    u\n      .combine('mipLevel', [0, 1, kDefaultMipLevelCount - 2])\n      .expand('dstOrigin', generateDstOriginValue)\n      .expand('copySize', generateCopySizeForDstOOB)\n  )\n  .fn(async t => {\n    const { mipLevel, dstOrigin, copySize } = t.params;\n\n    const imageBitmap = await createImageBitmap(\n      t.getImageData(kDefaultWidth + 1, kDefaultHeight + 1)\n    );\n    const dstTexture = t.device.createTexture({\n      size: {\n        width: kDefaultWidth,\n        height: kDefaultHeight,\n        depthOrArrayLayers: kDefaultDepth,\n      },\n      format: 'bgra8unorm',\n      mipLevelCount: kDefaultMipLevelCount,\n      usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,\n    });\n\n    let success = true;\n    let hasOperationError = false;\n    const dstMipMapSize = computeMipMapSize(kDefaultWidth, kDefaultHeight, mipLevel);\n\n    if (\n      copySize.depthOrArrayLayers > 1 ||\n      dstOrigin.x + copySize.width > dstMipMapSize.mipWidth ||\n      dstOrigin.y + copySize.height > dstMipMapSize.mipHeight ||\n      dstOrigin.z + copySize.depthOrArrayLayers > kDefaultDepth\n    ) {\n      success = false;\n    }\n    if (copySize.depthOrArrayLayers > 1) {\n      hasOperationError = true;\n    }\n\n    t.runTest(\n      { source: imageBitmap },\n      {\n        texture: dstTexture,\n        mipLevel,\n        origin: dstOrigin,\n      },\n      copySize,\n      success,\n      hasOperationError ? 'OperationError' : ''\n    );\n  });\n"],"file":"CopyExternalImageToTexture.spec.js"}