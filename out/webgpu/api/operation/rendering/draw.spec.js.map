{"version":3,"sources":["../../../../../src/webgpu/api/operation/rendering/draw.spec.ts"],"names":["description","params","pbool","poptions","makeTestGroup","assert","GPUTest","g","test","desc","cases","combine","expand","p","indexed","undefined","fn","t","renderTargetSize","numX","numY","tileSizeX","tileSizeY","triangleVertices","renderTarget","device","createTexture","size","usage","GPUTextureUsage","RENDER_ATTACHMENT","COPY_SRC","format","vertexModule","createShaderModule","code","fragmentModule","pipeline","createRenderPipeline","vertex","module","entryPoint","buffers","attributes","shaderLocation","offset","arrayStride","Float32Array","BYTES_PER_ELEMENT","fragment","targets","resultBuffer","createBuffer","Uint32Array","GPUBufferUsage","STORAGE","resultBindGroup","createBindGroup","layout","getBindGroupLayout","entries","binding","resource","buffer","commandEncoder","createCommandEncoder","renderPass","beginRenderPass","colorAttachments","attachment","createView","loadValue","setPipeline","setBindGroup","base_vertex","index_buffer_offset","setIndexBuffer","makeBufferWithContents","Array","INDEX","setVertexBuffer","vertex_buffer_offset","VERTEX","args","count","instance_count","first","first_instance","indirect","drawIndexedIndirect","INDIRECT","drawIndexed","apply","drawIndirect","draw","endPass","queue","submit","finish","green","Uint8Array","transparentBlack","didDraw","expectContents","baseVertex","primitiveId","instanceId","expectedColor","expectSinglePixelIn2DTexture","x","y","exp"],"mappings":"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","sourcesContent":["export const description = `\nTests for the general aspects of draw/drawIndexed/drawIndirect/drawIndexedIndirect.\n\nPrimitive topology tested in api/operation/render_pipeline/primitive_topology.spec.ts.\nIndex format tested in api/operation/command_buffer/render/state_tracking.spec.ts.\n\n* arguments - Test that draw arguments are passed correctly.\n\nTODO:\n* default_arguments - Test defaults to draw / drawIndexed.\n  - arg= {instance_count, first, first_instance, base_vertex}\n  - mode= {draw, drawIndexed}\n\n* vertex_attributes - Test fetching of vertex attributes\n  Each vertex attribute is a single value and written to one component of an output attachment.\n  4 components x 4 attachments is enough for 16 attributes. The test draws a grid of points\n  with a fixed number of primitives and instances.\n  Horizontally across the screen are primitives with increasing \"primitive id\".\n  Vertically down the screen are primitives with increasing instance id.\n\n  Params:\n  - vertex_attributes= {0, 1, max}\n  - vertex_buffer_count={0, 1, max} - where # attributes is > 0\n  - step_mode= {vertex, instanced, mixed} - where mixed only applies for vertex_attributes > 1\n\n* unaligned_vertex_count - Test that drawing with a number of vertices that's not a multiple of the vertices a given primitive list topology is not an error. The last primitive is not drawn.\n  - primitive_topology= {line-list, triangle-list}\n  - mode= {draw, drawIndexed, drawIndirect, drawIndexedIndirect}\n`;\n\nimport { params, pbool, poptions } from '../../../../common/framework/params_builder.js';\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { assert } from '../../../../common/framework/util/util.js';\nimport { GPUTest } from '../../../gpu_test.js';\n\nexport const g = makeTestGroup(GPUTest);\n\ng.test('arguments')\n  .desc(\n    `Test that draw arguments are passed correctly by drawing triangles in a grid.\nHorizontally across the texture are triangles with increasing \"primitive id\".\nVertically down the screen are triangles with increasing instance id.\nIncreasing the |first| param should skip some of the beginning triangles on the horizontal axis.\nIncreasing the |first_instance| param should skip of the beginning triangles on the vertical axis.\nThe vertex buffer contains two sets of disjoint triangles, and base_vertex is used to select the second set.\nThe test checks that the center of all of the expected triangles is drawn, and the others are empty.\nThe fragment shader also writes out to a storage buffer. If the draw is zero-sized, check that no value is written.\n\nParams:\n  - first= {0, 3} - either the firstVertex or firstIndex\n  - count= {0, 3, 6} - either the vertexCount or indexCount\n  - first_instance= {0, 2}\n  - instance_count= {0, 1, 4}\n  - indexed= {true, false}\n  - indirect= {true, false}\n  - vertex_buffer_offset= {0, 32}\n  - index_buffer_offset= {0, 16} - only for indexed draws\n  - base_vertex= {0, 9} - only for indexed draws\n  `\n  )\n  .cases(\n    params()\n      .combine(poptions('first', [0, 3] as const))\n      .combine(poptions('count', [0, 3, 6] as const))\n      .combine(poptions('first_instance', [0, 2] as const))\n      .combine(poptions('instance_count', [0, 1, 4] as const))\n      .combine(pbool('indexed'))\n      .combine(pbool('indirect'))\n      .combine(poptions('vertex_buffer_offset', [0, 32] as const))\n      .expand(p => poptions('index_buffer_offset', p.indexed ? ([0, 16] as const) : [undefined]))\n      .expand(p => poptions('base_vertex', p.indexed ? ([0, 9] as const) : [undefined]))\n  )\n  .fn(t => {\n    const renderTargetSize = [72, 36];\n\n    // The test will split up the render target into a grid where triangles of\n    // increasing primitive id will be placed along the X axis, and triangles\n    // of increasing instance id will be placed along the Y axis. The size of the\n    // grid is based on the max primitive id and instance id used.\n    const numX = 6;\n    const numY = 6;\n    const tileSizeX = renderTargetSize[0] / numX;\n    const tileSizeY = renderTargetSize[1] / numY;\n\n    // |\\\n    // |   \\\n    // |______\\\n    // Unit triangle shaped like this. 0-1 Y-down.\n    const triangleVertices = /* prettier-ignore */ [\n      0.0, 0.0,\n      0.0, 1.0,\n      1.0, 1.0,\n    ];\n\n    const renderTarget = t.device.createTexture({\n      size: renderTargetSize,\n      usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n      format: 'rgba8unorm',\n    });\n\n    const vertexModule = t.device.createShaderModule({\n      code: `\n[[builtin(vertex_index)]] var<in> vertex_index : u32;\n[[builtin(instance_index)]] var<in> instance_id : u32;\n[[location(0)]] var<in> vertexPosition : vec2<f32>;\n\n[[builtin(position)]] var<out> Position : vec4<f32>;\n[[stage(vertex)]] fn vert_main() -> void {\n  // 3u is the number of points in a triangle to convert from index\n  // to id.\n  var vertex_id : u32 = vertex_index / 3u;\n\n  var x : f32 = (vertexPosition.x + f32(vertex_id)) / ${numX}.0;\n  var y : f32 = (vertexPosition.y + f32(instance_id)) / ${numY}.0;\n\n  // (0,1) y-down space to (-1,1) y-up NDC\n  x = 2.0 * x - 1.0;\n  y = -2.0 * y + 1.0;\n  Position = vec4<f32>(x, y, 0.0, 1.0);\n}\n`,\n    });\n\n    const fragmentModule = t.device.createShaderModule({\n      code: `\n[[block]] struct Output {\n  value : u32;\n};\n\n[[group(0), binding(0)]] var<storage> output : Output;\n\n[[location(0)]] var<out> fragColor : vec4<f32>;\n[[stage(fragment)]] fn frag_main() -> void {\n  output.value = 1u;\n  fragColor = vec4<f32>(0.0, 1.0, 0.0, 1.0);\n}\n`,\n    });\n\n    const pipeline = t.device.createRenderPipeline({\n      vertex: {\n        module: vertexModule,\n        entryPoint: 'vert_main',\n        buffers: [\n          {\n            attributes: [\n              {\n                shaderLocation: 0,\n                format: 'float32x2',\n                offset: 0,\n              },\n            ],\n            arrayStride: 2 * Float32Array.BYTES_PER_ELEMENT,\n          },\n        ],\n      },\n      fragment: {\n        module: fragmentModule,\n        entryPoint: 'frag_main',\n        targets: [\n          {\n            format: 'rgba8unorm',\n          },\n        ],\n      },\n    });\n\n    const resultBuffer = t.device.createBuffer({\n      size: Uint32Array.BYTES_PER_ELEMENT,\n      usage: GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC,\n    });\n\n    const resultBindGroup = t.device.createBindGroup({\n      layout: pipeline.getBindGroupLayout(0),\n      entries: [\n        {\n          binding: 0,\n          resource: {\n            buffer: resultBuffer,\n          },\n        },\n      ],\n    });\n\n    const commandEncoder = t.device.createCommandEncoder();\n    const renderPass = commandEncoder.beginRenderPass({\n      colorAttachments: [\n        {\n          attachment: renderTarget.createView(),\n          loadValue: [0, 0, 0, 0],\n        },\n      ],\n    });\n\n    renderPass.setPipeline(pipeline);\n    renderPass.setBindGroup(0, resultBindGroup);\n\n    if (t.params.indexed) {\n      // INDEXED DRAW\n      assert(t.params.base_vertex !== undefined);\n      assert(t.params.index_buffer_offset !== undefined);\n\n      renderPass.setIndexBuffer(\n        t.makeBufferWithContents(\n          /* prettier-ignore */ new Uint32Array([\n            // Offset the index buffer contents by empty data.\n            ...new Array(t.params.index_buffer_offset / Uint32Array.BYTES_PER_ELEMENT),\n\n            0,  1,  2, //\n            3,  4,  5, //\n            6,  7,  8, //\n          ]),\n          GPUBufferUsage.INDEX\n        ),\n        'uint32',\n        t.params.index_buffer_offset\n      );\n\n      renderPass.setVertexBuffer(\n        0,\n        t.makeBufferWithContents(\n          /* prettier-ignore */ new Float32Array([\n            // Offset the vertex buffer contents by empty data.\n            ...new Array(t.params.vertex_buffer_offset / Float32Array.BYTES_PER_ELEMENT),\n\n            // selected with base_vertex=0\n                                 // count=6\n            ...triangleVertices, //   |   count=6;first=3\n            ...triangleVertices, //   |       |\n            ...triangleVertices, //           |\n\n            // selected with base_vertex=9\n                                 // count=6\n            ...triangleVertices, //   |   count=6;first=3\n            ...triangleVertices, //   |       |\n            ...triangleVertices, //           |\n          ]),\n          GPUBufferUsage.VERTEX\n        ),\n        t.params.vertex_buffer_offset\n      );\n\n      const args = [\n        t.params.count,\n        t.params.instance_count,\n        t.params.first,\n        t.params.base_vertex,\n        t.params.first_instance,\n      ] as const;\n      if (t.params.indirect) {\n        renderPass.drawIndexedIndirect(\n          t.makeBufferWithContents(new Uint32Array(args), GPUBufferUsage.INDIRECT),\n          0\n        );\n      } else {\n        renderPass.drawIndexed.apply(renderPass, [...args]);\n      }\n    } else {\n      // NON-INDEXED DRAW\n      renderPass.setVertexBuffer(\n        0,\n        t.makeBufferWithContents(\n          /* prettier-ignore */ new Float32Array([\n            // Offset the vertex buffer contents by empty data.\n            ...new Array(t.params.vertex_buffer_offset / Float32Array.BYTES_PER_ELEMENT),\n\n                                 // count=6\n            ...triangleVertices, //   |   count=6;first=3\n            ...triangleVertices, //   |       |\n            ...triangleVertices, //           |\n          ]),\n          GPUBufferUsage.VERTEX\n        ),\n        t.params.vertex_buffer_offset\n      );\n\n      const args = [\n        t.params.count,\n        t.params.instance_count,\n        t.params.first,\n        t.params.first_instance,\n      ] as const;\n      if (t.params.indirect) {\n        renderPass.drawIndirect(\n          t.makeBufferWithContents(new Uint32Array(args), GPUBufferUsage.INDIRECT),\n          0\n        );\n      } else {\n        renderPass.draw.apply(renderPass, [...args]);\n      }\n    }\n\n    renderPass.endPass();\n    t.queue.submit([commandEncoder.finish()]);\n\n    const green = new Uint8Array([0, 255, 0, 255]);\n    const transparentBlack = new Uint8Array([0, 0, 0, 0]);\n\n    const didDraw = t.params.count && t.params.instance_count;\n\n    t.expectContents(resultBuffer, new Uint32Array([didDraw ? 1 : 0]));\n\n    const baseVertex = t.params.base_vertex ?? 0;\n    for (let primitiveId = 0; primitiveId < numX; ++primitiveId) {\n      for (let instanceId = 0; instanceId < numY; ++instanceId) {\n        let expectedColor = didDraw ? green : transparentBlack;\n        if (\n          primitiveId * 3 < t.params.first + baseVertex ||\n          primitiveId * 3 >= t.params.first + baseVertex + t.params.count\n        ) {\n          expectedColor = transparentBlack;\n        }\n\n        if (\n          instanceId < t.params.first_instance ||\n          instanceId >= t.params.first_instance + t.params.instance_count\n        ) {\n          expectedColor = transparentBlack;\n        }\n\n        t.expectSinglePixelIn2DTexture(\n          renderTarget,\n          'rgba8unorm',\n          {\n            x: (1 / 3 + primitiveId) * tileSizeX,\n            y: (2 / 3 + instanceId) * tileSizeY,\n          },\n          {\n            exp: expectedColor,\n          }\n        );\n      }\n    }\n  });\n"],"file":"draw.spec.js"}