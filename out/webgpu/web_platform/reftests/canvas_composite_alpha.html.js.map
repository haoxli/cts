{"version":3,"sources":["../../../../src/webgpu/web_platform/reftests/canvas_composite_alpha.html.ts"],"names":["assert","unreachable","runRefTest","run","format","alphaMode","writeCanvasMethod","t","ctx","cvs","getContext","GPUCanvasContext","usage","GPUTextureUsage","RENDER_ATTACHMENT","COPY_DST","configure","device","kBlendStateSourceOver","color","srcFactor","dstFactor","operation","alpha","pipeline","createRenderPipeline","layout","vertex","module","createShaderModule","code","entryPoint","fragment","targets","blend","premultiplied","opaque","undefined","primitive","topology","renderTarget","getCurrentTexture","createTexture","size","canvas","width","height","COPY_SRC","renderPassDescriptor","colorAttachments","view","createView","clearValue","r","g","b","a","loadOp","storeOp","commandEncoder","createCommandEncoder","passEncoder","beginRenderPass","setPipeline","draw","end","copyTextureToTexture","texture","queue","submit","finish"],"mappings":"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","sourcesContent":["import { assert, unreachable } from '../../../common/util/util.js';\n\nimport { runRefTest } from './gpu_ref_test.js';\n\n// <canvas> element from html page\ndeclare const cvs: HTMLCanvasElement;\n\ntype WriteCanvasMethod = 'draw' | 'copy';\n\nexport function run(\n  format: GPUTextureFormat,\n  alphaMode: GPUCanvasAlphaMode,\n  writeCanvasMethod: WriteCanvasMethod\n) {\n  runRefTest(async t => {\n    const ctx = cvs.getContext('webgpu');\n    assert(ctx instanceof GPUCanvasContext, 'Failed to get WebGPU context from canvas');\n\n    switch (format) {\n      case 'bgra8unorm':\n      case 'bgra8unorm-srgb':\n      case 'rgba8unorm':\n      case 'rgba8unorm-srgb':\n      case 'rgba16float':\n        break;\n      default:\n        unreachable();\n    }\n\n    let usage = 0;\n    switch (writeCanvasMethod) {\n      case 'draw':\n        usage = GPUTextureUsage.RENDER_ATTACHMENT;\n        break;\n      case 'copy':\n        usage = GPUTextureUsage.COPY_DST;\n        break;\n    }\n    ctx.configure({\n      device: t.device,\n      format,\n      usage,\n      alphaMode,\n    });\n\n    // The blending behavior here is to mimic 2d context blending behavior\n    // of drawing rects in order\n    // https://drafts.fxtf.org/compositing/#porterduffcompositingoperators_srcover\n    const kBlendStateSourceOver = {\n      color: {\n        srcFactor: 'src-alpha',\n        dstFactor: 'one-minus-src-alpha',\n        operation: 'add',\n      },\n      alpha: {\n        srcFactor: 'one',\n        dstFactor: 'one-minus-src-alpha',\n        operation: 'add',\n      },\n    } as const;\n\n    const pipeline = t.device.createRenderPipeline({\n      layout: 'auto',\n      vertex: {\n        module: t.device.createShaderModule({\n          code: `\nstruct VertexOutput {\n@builtin(position) Position : vec4<f32>,\n@location(0) fragColor : vec4<f32>,\n}\n\n@vertex\nfn main(@builtin(vertex_index) VertexIndex : u32) -> VertexOutput {\nvar pos = array<vec2<f32>, 6>(\n    vec2<f32>( 0.75,  0.75),\n    vec2<f32>( 0.75, -0.75),\n    vec2<f32>(-0.75, -0.75),\n    vec2<f32>( 0.75,  0.75),\n    vec2<f32>(-0.75, -0.75),\n    vec2<f32>(-0.75,  0.75));\n\nvar offset = array<vec2<f32>, 4>(\nvec2<f32>( -0.25,  0.25),\nvec2<f32>( 0.25, 0.25),\nvec2<f32>(-0.25, -0.25),\nvec2<f32>( 0.25,  -0.25));\n\n// Alpha channel value is set to 0.5 regardless of the canvas alpha mode.\n// For 'opaque' mode, it shouldn't affect the end result, as the alpha channel should always get cleared to 1.0.\nvar color = array<vec4<f32>, 4>(\n    vec4<f32>(0.4, 0.0, 0.0, 0.5),\n    vec4<f32>(0.0, 0.4, 0.0, 0.5),\n    vec4<f32>(0.0, 0.0, 0.4, 0.5),\n    vec4<f32>(0.4, 0.4, 0.0, 0.5)); // 0.4 -> 0x66\n\nvar output : VertexOutput;\noutput.Position = vec4<f32>(pos[VertexIndex % 6u] + offset[VertexIndex / 6u], 0.0, 1.0);\noutput.fragColor = color[VertexIndex / 6u];\nreturn output;\n}\n        `,\n        }),\n        entryPoint: 'main',\n      },\n      fragment: {\n        module: t.device.createShaderModule({\n          code: `\n@fragment\nfn main(@location(0) fragColor: vec4<f32>) -> @location(0) vec4<f32> {\nreturn fragColor;\n}\n        `,\n        }),\n        entryPoint: 'main',\n        targets: [\n          {\n            format,\n            blend: { premultiplied: kBlendStateSourceOver, opaque: undefined }[alphaMode],\n          },\n        ],\n      },\n      primitive: {\n        topology: 'triangle-list',\n      },\n    });\n\n    let renderTarget: GPUTexture;\n    switch (writeCanvasMethod) {\n      case 'draw':\n        renderTarget = ctx.getCurrentTexture();\n        break;\n      case 'copy':\n        renderTarget = t.device.createTexture({\n          size: [ctx.canvas.width, ctx.canvas.height],\n          format,\n          usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n        });\n        break;\n    }\n    const renderPassDescriptor: GPURenderPassDescriptor = {\n      colorAttachments: [\n        {\n          view: renderTarget.createView(),\n          clearValue: { r: 0.0, g: 0.0, b: 0.0, a: 0.0 },\n          loadOp: 'clear',\n          storeOp: 'store',\n        },\n      ],\n    };\n\n    const commandEncoder = t.device.createCommandEncoder();\n    const passEncoder = commandEncoder.beginRenderPass(renderPassDescriptor);\n    passEncoder.setPipeline(pipeline);\n    passEncoder.draw(6, 1, 0, 0);\n    passEncoder.draw(6, 1, 6, 0);\n    passEncoder.draw(6, 1, 12, 0);\n    passEncoder.draw(6, 1, 18, 0);\n    passEncoder.end();\n\n    switch (writeCanvasMethod) {\n      case 'draw':\n        break;\n      case 'copy':\n        commandEncoder.copyTextureToTexture(\n          {\n            texture: renderTarget,\n          },\n          {\n            texture: ctx.getCurrentTexture(),\n          },\n          [ctx.canvas.width, ctx.canvas.height]\n        );\n        break;\n    }\n\n    t.device.queue.submit([commandEncoder.finish()]);\n  });\n}\n"],"file":"canvas_composite_alpha.html.js"}