{"version":3,"sources":["../../../src/webgpu/web_platform/util.ts"],"names":["raceWithRejectOnTimeout","startPlayingAndWaitForVideo","video","callback","Promise","resolve","reject","callbackAndResolve","ex","error","Error","addEventListener","e","message","requestVideoFrameCallback","timeWatcher","currentTime","requestAnimationFrame","loop","muted","preload","play"],"mappings":";AAAA;AACA,GADA,SAASA,uBAAT,QAAwC,2BAAxC,C,CAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,SAASC,2BAAT;AACLC,KADK;AAELC,QAFK;AAGU;AACf,SAAOH,uBAAuB;AAC5B,MAAII,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AAC/B,UAAMC,kBAAkB,GAAG,YAAY;AACrC,UAAI;AACF,cAAMJ,QAAQ,EAAd;AACAE,QAAAA,OAAO;AACR,OAHD,CAGE,OAAOG,EAAP,EAAW;AACXF,QAAAA,MAAM;AACP;AACF,KAPD;;AASA,QAAIJ,KAAK,CAACO,KAAV,EAAiB;AACfH,MAAAA,MAAM,CAAC,IAAII,KAAJ,CAAU,2BAA2BR,KAAK,CAACO,KAA3C,CAAD,CAAN;AACA;AACD;;AAEDP,IAAAA,KAAK,CAACS,gBAAN;AACE,WADF;AAEEC,IAAAA,CAAC,IAAIN,MAAM,CAAC,IAAII,KAAJ,CAAU,4BAA4BE,CAAC,CAACC,OAAxC,CAAD,CAFb;AAGE,QAHF;;;AAMA,QAAI,+BAA+BX,KAAnC,EAA0C;;AAEvCA,MAAAA,KAAD,CAAeY,yBAAf,CAAyC,MAAM;AAC7CP,QAAAA,kBAAkB;AACnB,OAFD;AAGD,KALD,MAKO;AACL;AACA,YAAMQ,WAAW,GAAG,MAAM;AACxB,YAAIb,KAAK,CAACc,WAAN,GAAoB,CAAxB,EAA2B;AACzBT,UAAAA,kBAAkB;AACnB,SAFD,MAEO;AACLU,UAAAA,qBAAqB,CAACF,WAAD,CAArB;AACD;AACF,OAND;AAOAA,MAAAA,WAAW;AACZ;;AAEDb,IAAAA,KAAK,CAACgB,IAAN,GAAa,IAAb;AACAhB,IAAAA,KAAK,CAACiB,KAAN,GAAc,IAAd;AACAjB,IAAAA,KAAK,CAACkB,OAAN,GAAgB,MAAhB;AACAlB,IAAAA,KAAK,CAACmB,IAAN;AACD,GA1CD,CAD4B;AA4C5B,MA5C4B;AA6C5B,4BA7C4B,CAA9B;;AA+CD","sourcesContent":["import { raceWithRejectOnTimeout } from '../../common/util/util.js';\n\n/**\n * Starts playing a video and waits for it to be consumable.\n * Promise resolves after the callback has been called.\n *\n * @param video An HTML5 Video element.\n * @param callback Function to call when video is ready.\n *\n * Copied from https://github.com/KhronosGroup/WebGL/blob/main/sdk/tests/js/webgl-test-utils.js\n */\nexport function startPlayingAndWaitForVideo(\n  video: HTMLVideoElement,\n  callback: () => unknown\n): Promise<void> {\n  return raceWithRejectOnTimeout(\n    new Promise((resolve, reject) => {\n      const callbackAndResolve = async () => {\n        try {\n          await callback();\n          resolve();\n        } catch (ex) {\n          reject();\n        }\n      };\n\n      if (video.error) {\n        reject(new Error('Video failed to load: ' + video.error));\n        return;\n      }\n\n      video.addEventListener(\n        'error',\n        e => reject(new Error('Video playback failed: ' + e.message)),\n        true\n      );\n\n      if ('requestVideoFrameCallback' in video) {\n        /* eslint-disable-next-line @typescript-eslint/no-explicit-any */\n        (video as any).requestVideoFrameCallback(() => {\n          callbackAndResolve();\n        });\n      } else {\n        // If requestVideoFrameCallback isn't available, check each frame if the video has advanced.\n        const timeWatcher = () => {\n          if (video.currentTime > 0) {\n            callbackAndResolve();\n          } else {\n            requestAnimationFrame(timeWatcher);\n          }\n        };\n        timeWatcher();\n      }\n\n      video.loop = true;\n      video.muted = true;\n      video.preload = 'auto';\n      video.play();\n    }),\n    2000,\n    'Video never became ready'\n  );\n}\n"],"file":"util.js"}