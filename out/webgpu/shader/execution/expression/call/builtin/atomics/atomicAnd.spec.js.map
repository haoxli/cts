{"version":3,"file":"atomicAnd.spec.js","names":["description","makeTestGroup","keysOf","GPUTest","dispatchSizes","workgroupSizes","runTest","kMapId","g","test","specURL","desc","params","u","combine","fn","t","numInvocations","workgroupSize","dispatchSize","bufferNumElements","Math","max","initValue","mapId","extra","wgsl","op","expected","Uint32Array","fill","id","i","f","floor"],"sources":["../../../../../../../../src/webgpu/shader/execution/expression/call/builtin/atomics/atomicAnd.spec.ts"],"sourcesContent":["export const description = `\nAtomically read, and and store value.\n\n* Load the original value pointed to by atomic_ptr.\n* Obtains a new value by anding with the value v.\n* Store the new value using atomic_ptr.\n\nReturns the original value stored in the atomic object.\n`;\n\nimport { makeTestGroup } from '../../../../../../../common/framework/test_group.js';\nimport { keysOf } from '../../../../../../../common/util/data_tables.js';\nimport { GPUTest } from '../../../../../../gpu_test.js';\n\nimport { dispatchSizes, workgroupSizes, runTest, kMapId } from './harness.js';\n\nexport const g = makeTestGroup(GPUTest);\n\ng.test('and')\n  .specURL('https://www.w3.org/TR/WGSL/#atomic-rmw')\n  .desc(\n    `\nAS is storage or workgroup\nT is i32 or u32\n\nfn atomicAnd(atomic_ptr: ptr<AS, atomic<T>, read_write>, v: T) -> T\n`\n  )\n  .params(u =>\n    u\n      .combine('workgroupSize', workgroupSizes)\n      .combine('dispatchSize', dispatchSizes)\n      .combine('mapId', keysOf(kMapId))\n  )\n  .fn(t => {\n    const numInvocations = t.params.workgroupSize * t.params.dispatchSize;\n\n    // Allocate an output buffer with bitsize of max invocations plus 1 for validation\n    const bufferNumElements = Math.max(1, numInvocations / 32) + 1;\n\n    // Start with all bits high, then using atomicAnd to set mapped global id bit off.\n    // Note: Both WGSL and JS will shift left 1 by id modulo 32.\n    const initValue = 0xffffffff;\n\n    const mapId = kMapId[t.params.mapId];\n    const extra = mapId.wgsl(numInvocations); // Defines map_id()\n    const op = `\n      let i = map_id(id);\n      atomicAnd(&output[i / 32], ~(1u << i))\n    `;\n\n    const expected = new Uint32Array(bufferNumElements).fill(initValue);\n    for (let id = 0; id < numInvocations; ++id) {\n      const i = mapId.f(id, numInvocations);\n      expected[Math.floor(i / 32)] &= ~(1 << i);\n    }\n\n    runTest({\n      t,\n      workgroupSize: t.params.workgroupSize,\n      dispatchSize: t.params.dispatchSize,\n      bufferNumElements,\n      initValue,\n      op,\n      expected,\n      extra,\n    });\n  });\n"],"mappings":";AAAA;AAAA,GAAA,OAAO,MAAMA,WAAW,GAAI;AAC5B;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,CAED,SAASC,aAAa,QAAQ,qDAAqD;AACnF,SAASC,MAAM,QAAQ,iDAAiD;AACxE,SAASC,OAAO,QAAQ,+BAA+B;;AAEvD,SAASC,aAAa,EAAEC,cAAc,EAAEC,OAAO,EAAEC,MAAM,QAAQ,cAAc;;AAE7E,OAAO,MAAMC,CAAC,GAAGP,aAAa,CAACE,OAAO,CAAC;;AAEvCK,CAAC,CAACC,IAAI,CAAC,KAAK,CAAC;AACVC,OAAO,CAAC,wCAAwC,CAAC;AACjDC,IAAI;AACF;AACL;AACA;AACA;AACA;AACA,CAAC,CACE;;AACAC,MAAM,CAAC,CAAAC,CAAC;AACPA,CAAC;AACEC,OAAO,CAAC,eAAe,EAAET,cAAc,CAAC;AACxCS,OAAO,CAAC,cAAc,EAAEV,aAAa,CAAC;AACtCU,OAAO,CAAC,OAAO,EAAEZ,MAAM,CAACK,MAAM,CAAC,CAAC,CACpC;;AACAQ,EAAE,CAAC,CAAAC,CAAC,KAAI;EACP,MAAMC,cAAc,GAAGD,CAAC,CAACJ,MAAM,CAACM,aAAa,GAAGF,CAAC,CAACJ,MAAM,CAACO,YAAY;;EAErE;EACA,MAAMC,iBAAiB,GAAGC,IAAI,CAACC,GAAG,CAAC,CAAC,EAAEL,cAAc,GAAG,EAAE,CAAC,GAAG,CAAC;;EAE9D;EACA;EACA,MAAMM,SAAS,GAAG,UAAU;;EAE5B,MAAMC,KAAK,GAAGjB,MAAM,CAACS,CAAC,CAACJ,MAAM,CAACY,KAAK,CAAC;EACpC,MAAMC,KAAK,GAAGD,KAAK,CAACE,IAAI,CAACT,cAAc,CAAC,CAAC,CAAC;EAC1C,MAAMU,EAAE,GAAI;AAChB;AACA;AACA,KAAK;;EAED,MAAMC,QAAQ,GAAG,IAAIC,WAAW,CAACT,iBAAiB,CAAC,CAACU,IAAI,CAACP,SAAS,CAAC;EACnE,KAAK,IAAIQ,EAAE,GAAG,CAAC,EAAEA,EAAE,GAAGd,cAAc,EAAE,EAAEc,EAAE,EAAE;IAC1C,MAAMC,CAAC,GAAGR,KAAK,CAACS,CAAC,CAACF,EAAE,EAAEd,cAAc,CAAC;IACrCW,QAAQ,CAACP,IAAI,CAACa,KAAK,CAACF,CAAC,GAAG,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC,IAAIA,CAAC,CAAC;EAC3C;;EAEA1B,OAAO,CAAC;IACNU,CAAC;IACDE,aAAa,EAAEF,CAAC,CAACJ,MAAM,CAACM,aAAa;IACrCC,YAAY,EAAEH,CAAC,CAACJ,MAAM,CAACO,YAAY;IACnCC,iBAAiB;IACjBG,SAAS;IACTI,EAAE;IACFC,QAAQ;IACRH;EACF,CAAC,CAAC;AACJ,CAAC,CAAC"}