{"version":3,"file":"harness.js","names":["workgroupSizes","dispatchSizes","kMapId","passthrough","f","id","max","wgsl","remap","runTest","t","workgroupSize","dispatchSize","bufferNumElements","initValue","op","expected","extra","pipeline","device","createComputePipeline","layout","compute","module","createShaderModule","code","entryPoint","outputBuffer","createBuffer","size","Uint32Array","BYTES_PER_ELEMENT","usage","GPUBufferUsage","STORAGE","COPY_SRC","mappedAtCreation","trackForCleanup","data","getMappedRange","fill","unmap","bindGroup","createBindGroup","getBindGroupLayout","entries","binding","resource","buffer","encoder","createCommandEncoder","pass","beginComputePass","setPipeline","setBindGroup","dispatchWorkgroups","end","queue","submit","finish","expectGPUBufferValuesEqual"],"sources":["../../../../../../../../src/webgpu/shader/execution/expression/call/builtin/atomics/harness.ts"],"sourcesContent":["import { GPUTest } from '../../../../../../gpu_test';\n\nexport const workgroupSizes = [1, 2, 32, 64];\nexport const dispatchSizes = [1, 4, 8, 16];\nexport const kMapId = {\n  passthrough: {\n    f: (id: number, max: number) => id,\n    wgsl: (max: number) => 'fn map_id(id: u32) -> u32 { return id; }',\n  },\n  remap: {\n    f: (id: number, max: number) => (((id >>> 0) * 14957) ^ (((id >>> 0) * 26561) >> 2)) % max,\n    wgsl: (max: number) =>\n      `fn map_id(id: u32) -> u32 { return ((id * 14957) ^ ((id * 26561) >> 2)) % ${max}; }`,\n  },\n};\n\nexport function runTest({\n  t,\n  workgroupSize, // Workgroup X-size\n  dispatchSize, // Dispatch X-size\n  bufferNumElements, // Number of 32-bit elements in output buffer\n  initValue, // 32-bit initial value used to fill output buffer\n  op, // Atomic op source executed by the compute shader\n  expected, // Expected values array to compare against output buffer\n  extra, // Optional extra WGSL source\n}: {\n  t: GPUTest;\n  workgroupSize: number;\n  dispatchSize: number;\n  bufferNumElements: number;\n  initValue: number;\n  op: string;\n  expected: Uint32Array;\n  extra?: string;\n}) {\n  const wgsl = `\n    @group(0) @binding(0)\n    var<storage, read_write> output: array<atomic<u32>>;\n    \n    @compute @workgroup_size(${workgroupSize})\n    fn main(\n        @builtin(global_invocation_id) global_invocation_id : vec3<u32>,\n        ) {\n      let id = global_invocation_id[0];\n      ${op};\n    }\n    ${extra || ''}\n    `;\n\n  const pipeline = t.device.createComputePipeline({\n    layout: 'auto',\n    compute: {\n      module: t.device.createShaderModule({ code: wgsl }),\n      entryPoint: 'main',\n    },\n  });\n\n  const outputBuffer = t.device.createBuffer({\n    size: bufferNumElements * Uint32Array.BYTES_PER_ELEMENT,\n    usage: GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC,\n    mappedAtCreation: true,\n  });\n  // Fill with initial value\n  t.trackForCleanup(outputBuffer);\n  const data = new Uint32Array(outputBuffer.getMappedRange());\n  data.fill(initValue);\n  outputBuffer.unmap();\n\n  const bindGroup = t.device.createBindGroup({\n    layout: pipeline.getBindGroupLayout(0),\n    entries: [{ binding: 0, resource: { buffer: outputBuffer } }],\n  });\n\n  // Run the shader.\n  const encoder = t.device.createCommandEncoder();\n  const pass = encoder.beginComputePass();\n  pass.setPipeline(pipeline);\n  pass.setBindGroup(0, bindGroup);\n  pass.dispatchWorkgroups(dispatchSize);\n  pass.end();\n  t.queue.submit([encoder.finish()]);\n\n  t.expectGPUBufferValuesEqual(outputBuffer, expected);\n}\n"],"mappings":"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"}